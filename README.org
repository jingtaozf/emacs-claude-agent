# -*- encoding:utf-8 Mode: POLY-ORG;  -*- ---
#+Startup: noindent
#+PROPERTY: header-args :results silent :eval no-export :comments org
#+OPTIONS: num:nil toc:2 todo:nil tasks:nil tags:nil
#+OPTIONS: skip:nil author:nil email:nil creator:nil timestamp:t
#+PROPERTY: literate-lang elisp
#+PROPERTY: literate-load yes
#+TITLE: Emacs Claude Agent
#+DESCRIPTION: Native Emacs SDK for Claude Code with org-mode as the interactive UI
#+AUTHOR: Jingtao Xu

* Table of Contents                                                   :TOC:
- [[#introduction][Introduction]]
  - [[#what-is-emacs-claude-agent][What is Emacs Claude Agent?]]
  - [[#why-org-mode-as-the-ui][Why Org-mode as the UI?]]
  - [[#modules][Modules]]
- [[#tutorial][Tutorial]]
  - [[#step-1-prerequisites--installation][Step 1: Prerequisites & Installation]]
    - [[#prerequisites][Prerequisites]]
    - [[#installation][Installation]]
  - [[#step-2-your-first-query-interactive-chat][Step 2: Your First Query (Interactive Chat)]]
    - [[#instructions][Instructions]]
    - [[#key-bindings][Key Bindings]]
  - [[#step-3-org-mode-integration][Step 3: Org-mode Integration]]
    - [[#instructions-1][Instructions]]
    - [[#what-happened][What Happened?]]
    - [[#header-line-features][Header Line Features]]
    - [[#auto-enable-claude-org-mode][Auto-enable claude-org-mode]]
  - [[#step-4-the-transient-menu-c-c-c-][Step 4: The Transient Menu (=C-c C-/=)]]
    - [[#opening-the-menu][Opening the Menu]]
    - [[#menu-structure][Menu Structure]]
    - [[#permission-control][Permission Control]]
  - [[#step-5-session-management][Step 5: Session Management]]
    - [[#how-sessions-work][How Sessions Work]]
    - [[#section-scoped-sessions][Section-Scoped Sessions]]
    - [[#session-recovery][Session Recovery]]
  - [[#step-6-sdd-spec-driven-development][Step 6: SDD (Spec-Driven Development)]]
    - [[#creating-an-sdd-structure][Creating an SDD Structure]]
    - [[#workflow-phases][Workflow Phases]]
    - [[#key-principles][Key Principles]]
- [[#features][Features]]
  - [[#session-management][Session Management]]
    - [[#in-claude-org-mode][In claude-org-mode]]
    - [[#session-recovery-1][Session Recovery]]
  - [[#permission-functions][Permission Functions]]
    - [[#how-it-works][How It Works]]
    - [[#built-in-permission-functions][Built-in Permission Functions]]
    - [[#pattern-based-permissions][Pattern-Based Permissions]]
    - [[#custom-permission-functions][Custom Permission Functions]]
    - [[#org-file-protection][Org File Protection]]
  - [[#permission-modes][Permission Modes]]
    - [[#permission-presets][Permission Presets]]
    - [[#in-claude-org-mode-1][In claude-org-mode]]
    - [[#pattern-syntax][Pattern Syntax]]
  - [[#ide-context][IDE Context]]
    - [[#excluding-buffers][Excluding Buffers]]
  - [[#project-configuration-claude-org][Project Configuration (claude-org)]]
    - [[#project_root][PROJECT_ROOT]]
    - [[#system-prompts][System Prompts]]
    - [[#environment-variables][Environment Variables]]
  - [[#org-link-resolution][Org Link Resolution]]
    - [[#supported-link-types][Supported Link Types]]
    - [[#usage-example][Usage Example]]
  - [[#behavior-prompts-tagheader-system][Behavior Prompts (Tag/Header System)]]
    - [[#phase-tags][Phase Tags]]
    - [[#modifier-tags][Modifier Tags]]
    - [[#header-arguments][Header Arguments]]
  - [[#mcp-server-emacs-tools-for-claude][MCP Server (Emacs Tools for Claude)]]
    - [[#manual-control][Manual Control]]
    - [[#available-tools][Available Tools]]
    - [[#registering-custom-tools][Registering Custom Tools]]
  - [[#output-formatting-claude-org][Output Formatting (claude-org)]]
    - [[#header-normalization][Header Normalization]]
    - [[#auto-line-breaking][Auto Line Breaking]]
    - [[#auto-title-generation][Auto Title Generation]]
  - [[#error-analysis][Error Analysis]]
    - [[#usage][Usage]]
    - [[#automatic-analysis-recommended][Automatic Analysis (Recommended)]]
  - [[#activity-mode-line][Activity Mode-Line]]
  - [[#usage-mode-line][Usage Mode-Line]]
    - [[#setup][Setup]]
    - [[#usage-1][Usage]]
  - [[#verbose-output-buffers][Verbose Output Buffers]]
  - [[#skills-user-settings][Skills (User Settings)]]
    - [[#setting-sources][Setting Sources]]
    - [[#skill-file-format][Skill File Format]]
  - [[#configuration-reference][Configuration Reference]]
    - [[#claude-agent][claude-agent]]
    - [[#claude-org][claude-org]]
    - [[#emacs-mcp-server][emacs-mcp-server]]
    - [[#claude-agent-chat][claude-agent-chat]]
  - [[#api-reference][API Reference]]
    - [[#core-functions-claude-agent][Core Functions (claude-agent)]]
    - [[#client-functions][Client Functions]]
    - [[#org-functions-claude-org][Org Functions (claude-org)]]
    - [[#mcp-server-functions][MCP Server Functions]]
  - [[#faq][FAQ]]
    - [[#installation-issues][Installation Issues]]
    - [[#session-issues][Session Issues]]
    - [[#permission-issues][Permission Issues]]
    - [[#mcp-server-issues][MCP Server Issues]]
    - [[#org-mode-issues][Org-mode Issues]]
- [[#appendix][Appendix]]
  - [[#related-projects][Related Projects]]
    - [[#reference-implementation][Reference Implementation]]
    - [[#dependencies][Dependencies]]
    - [[#alternative-approaches][Alternative Approaches]]
  - [[#running-tests][Running Tests]]
    - [[#quick-start][Quick Start]]
    - [[#running-tests-in-emacs][Running Tests in Emacs]]
  - [[#license][License]]

* Introduction
:PROPERTIES:
:CUSTOM_ID: introduction
:END:

** What is Emacs Claude Agent?
:PROPERTIES:
:CUSTOM_ID: what-is-emacs-claude-agent
:END:

An Emacs client library for the [[https://claude.ai/code][Claude Code CLI]], implemented using literate
programming in Org mode. It transforms AI conversations into persistent, searchable documents.

#+BEGIN_SRC elisp :load no
;; Quick taste - send a query to Claude
(claude-agent-query "What is 2+2?"
  :on-message (lambda (msg)
                (message "Response: %s" (claude-agent-extract-text msg))))
#+END_SRC

** Why Org-mode as the UI?
:PROPERTIES:
:CUSTOM_ID: why-org-mode-as-the-ui
:END:

Claude Code CLI is powerful, but terminal conversations are ephemeral. Org-mode transforms
AI interactions into *living documents*:

| Terminal Limitation     | Org-mode Solution                               |
|-------------------------+-------------------------------------------------|
| Conversations disappear | Every conversation saved, searchable            |
| Linear workflow         | Hierarchical organization by feature/topic      |
| No context persistence  | Session continuity across Emacs restarts        |
| Manual documentation    | Literate programming - code + discussion + docs |

** Modules
:PROPERTIES:
:CUSTOM_ID: modules
:END:

| Module             | File                   | Purpose                                              |
|--------------------+------------------------+------------------------------------------------------|
| *claude-agent*     | =claude-agent.org=     | Core SDK: process management, query API, permissions |
| *claude-org*       | =claude-org.org=       | Org-mode integration: AI blocks, streaming, sessions |
| *emacs-mcp-server* | =emacs-mcp-server.org= | MCP HTTP server: exposes Emacs tools to Claude       |

* Tutorial
:PROPERTIES:
:CUSTOM_ID: tutorial
:END:

This tutorial walks you through Emacs Claude Agent step by step.

** Step 1: Prerequisites & Installation
:PROPERTIES:
:CUSTOM_ID: step-1-prerequisites--installation
:END:

*** Prerequisites

- Emacs 28+ (includes transient) or Emacs 27.1+ with [[https://github.com/magit/transient][transient]] installed
- Claude Code CLI: =npm install -g @anthropic-ai/claude-code=
- [[https://github.com/jingtaozf/literate-elisp][literate-elisp]] for loading org files directly

*** Installation

*1. Install dependencies:*

#+BEGIN_SRC elisp :load no
;; Using use-package with straight.el
(use-package literate-elisp
  :straight (:type git :host github :repo "jingtaozf/literate-elisp"))

(use-package web-server
  :straight (:type git :host github :repo "eschulte/emacs-web-server"))

;; Transient (built into Emacs 28+, required for Emacs 27)
(use-package transient
  :straight (:type git :host github :repo "magit/transient")
  :if (< emacs-major-version 28))
#+END_SRC

*2. Install emacs-claude-agent:*

#+BEGIN_SRC elisp :load no
(use-package claude-agent
  :demand t
  :straight (:type git :host github :repo "jingtaozf/emacs-claude-agent")
  :config
  ;; Optional: Set CLI path if not in PATH
  ;; (setq claude-agent-cli-path "/path/to/claude")

  ;; Permission functions configuration
  (setq claude-agent-permission-functions
        '(claude-agent-permission-check-patterns
          claude-org-permission-protect-org
          claude-agent-permission-auto-allow))

  ;; Optional: Auto-analyze errors
  (add-hook 'debugger-mode-hook #'claude-agent-analyze-backtrace))
#+END_SRC

** Step 2: Your First Query (Interactive Chat)
:PROPERTIES:
:CUSTOM_ID: step-2-your-first-query-interactive-chat
:END:

The simplest way to start is with the interactive chat buffer.

*** Instructions

*1. Open the chat buffer:*

#+BEGIN_EXAMPLE
M-x claude-agent-chat
#+END_EXAMPLE

*2. Type a message and press =RET=:*

#+BEGIN_EXAMPLE
You> What is the capital of France?
#+END_EXAMPLE

*3. Wait for the response to stream in.*

*** Key Bindings

| Key       | Action                          |
|-----------+---------------------------------|
| =RET=     | Send message                    |
| =C-c C-k= | Interrupt current request       |
| =C-c C-l= | Clear and reset session         |
| =C-c C-n= | Start new session without clearing |

** Step 3: Org-mode Integration
:PROPERTIES:
:CUSTOM_ID: step-3-org-mode-integration
:END:

For persistent, organized conversations, use org-mode integration.

*** Instructions

*1. Create a new org file:*

#+BEGIN_SRC elisp :load no
(find-file "/tmp/my-claude-test.org")
#+END_SRC

*2. Enable claude-org-mode:*

#+BEGIN_EXAMPLE
M-x claude-org-mode
#+END_EXAMPLE

*3. Insert an AI block using the transient menu:*

#+BEGIN_EXAMPLE
C-c C-/ i    (or M-x claude-org-insert-block)
#+END_EXAMPLE

This opens a workflow tag selector. Press =RET= to create a simple block (no tags),
or select workflow phases (=r= Research, =d= Design, =p= Planning, =i= Implementation).

*4. Type your query inside the block:*

#+BEGIN_EXAMPLE
,#+begin_src ai
What is 2 + 2? Reply with just the number.
,#+end_src
#+END_EXAMPLE

*5. Execute with =C-c C-c= and watch the response stream after the block.*

*** What Happened?

- =claude-org-insert-block= creates a new AI block with proper structure
- =:claude_chat:= tag marks the section as an AI conversation
- =#+begin_src ai= block contains your query
- =C-c C-c= sends the query to Claude
- Response appears directly after the block
- MCP server starts automatically, allowing Claude to interact with Emacs

*** Header Line Features

When =claude-org-mode= is active, the header line shows:
- *Session scope*: =[file-only]= or =[sec:session-id...]= for section-scoped sessions
- *Permission mode*: Current permission preset (=RO=, =AE=, =PL=, =BP=)
- *Active count*: Number of thinking queries (click to open session manager)
- *Project root*: Working directory from =PROJECT_ROOT= property
- *Current file*: The file Claude is working with (from IDE context)
- *Selection*: Line range and size of selected text (for context)

*** Auto-enable claude-org-mode

Add this as the first line of your org file:

#+BEGIN_EXAMPLE
# -*- mode: org; eval: (claude-org-mode 1) -*-
#+END_EXAMPLE

** Step 4: The Transient Menu (=C-c C-/=)
:PROPERTIES:
:CUSTOM_ID: step-4-transient-menu
:END:

The transient menu (=C-c C-/=) is the main user interface for claude-org. It provides
quick access to all common operations.

*** Opening the Menu

#+BEGIN_EXAMPLE
C-c C-/
#+END_EXAMPLE

*** Menu Structure

| Group | Key | Command | Description |
|-------+-----+---------+-------------|
| Execute | =c= | Execute | Execute the current AI block (=C-c C-c=) |
| | =k= | Cancel | Cancel current query |
| | =v= | Verbose | Show verbose output buffer |
| Insert | =i= | New AI block | Insert new AI block with workflow tag selection |
| | =s= | Story section | Insert new story section |
| | =d= | SDD structure | Create SDD (Spec-Driven Development) structure |
| Navigate | =j= | Jump | Jump to AI block |
| Session | =n= | Session info | Show current session identity |
| | =l= | List sessions | List all sessions |
| | =p= | Permission mode | Switch permission mode |

*** Permission Control

Permission mode can be changed via the transient menu (=C-c C-/ p=):

| Preset | Description |
|--------+-------------|
| =readonly= | Read, Glob, Grep only (safest) |
| =accept-edits= | + Write, Edit, MultiEdit (recommended) |
| =plan= | Suggests changes only |
| =bypass= | Allow all tools (use with caution) |

** Step 5: Session Management
:PROPERTIES:
:CUSTOM_ID: step-5-session-management
:END:

Sessions preserve conversation context across queries.

*** How Sessions Work

Each org file has a *file-scope session* by default. All queries in the file share context:

#+BEGIN_EXAMPLE
,* First Question :claude_chat:

,#+begin_src ai
My favorite number is 42. Remember this.
,#+end_src

,* Second Question :claude_chat:

,#+begin_src ai
What is my favorite number?
,#+end_src
#+END_EXAMPLE

Claude will remember "42" because both queries share the same session.

*** Section-Scoped Sessions

Use =CLAUDE_SESSION_ID= property to create independent sessions:

#+BEGIN_EXAMPLE
,* Task A
:PROPERTIES:
:CLAUDE_SESSION_ID: task-a-session
:END:

This section has its OWN session.

,#+begin_src ai
Remember: the password is "secret123"
,#+end_src

,* Task B
:PROPERTIES:
:CLAUDE_SESSION_ID: task-b-session
:END:

This is a DIFFERENT session from Task A.

,#+begin_src ai
What password did I tell you?
,#+end_src
#+END_EXAMPLE

Task B will NOT know the password - it has a separate session.

*** Session Recovery

When Claude sessions expire (after inactivity), claude-org automatically:
1. Collects conversation history from the org file
2. Rebuilds context with a recovery prompt
3. Retries transparently

*Performance tip:* Tag old sections with =:ARCHIVE:= to exclude from recovery.

** Step 6: SDD (Spec-Driven Development)
:PROPERTIES:
:CUSTOM_ID: step-6-sdd
:END:

SDD is a structured workflow for feature development - the key feature for serious
development work. It follows the Atomic pattern: Research → Design → Planning → Implementation.

*** Creating an SDD Structure

Use =C-c C-/= then =d= (or =M-x claude-org-insert-sdd=) to create a new SDD:

#+BEGIN_EXAMPLE
,* My Feature
:PROPERTIES:
:CLAUDE_SESSION_ID: sdd-20250101-120000
:END:

,** Workflow :sdd:

,*** Instruction 1 :claude_chat:

,#+begin_src ai
<your query here>
,#+end_src

,** Research Output :research_output:

,*** Codebase Patterns

,*** Relevant Files

,*** External References

,** Spec :spec:

,*** Goals

,*** Non-Goals

,*** Proposed Solution

,*** Technical Design

,** Features :features:
:PROPERTIES:
:ORDERED: t
:END:
#+END_EXAMPLE

*** Workflow Phases

| Phase | Tag | Purpose | Updates |
|-------+-----+---------+---------|
| Research | =:research:= | Explore codebase | → Research Output section |
| Design | =:design:= | Technical RFC | → Spec section |
| Planning | =:planning:= | Task breakdown | → Features section (TODOs) |
| Implementation | =:implementation:= | Write code | → Mark TODOs as DONE |

*** Key Principles

1. *Dual Memory*: Spec = lasting memory, Workflow = active memory
2. *Human Checkpoints*: Get approval at Research→Design and Planning→Implementation
3. *Atomic Features*: Each TODO should be completable in one session
4. *Update as you go*: Claude updates Research Output, Spec, Features via =evalElisp=

* Features
:PROPERTIES:
:CUSTOM_ID: features
:END:

Detailed documentation for all features.

** Session Management
:PROPERTIES:
:CUSTOM_ID: ref-session-management
:END:

Sessions preserve conversation context across queries.

*** In claude-org-mode

Sessions are automatically managed per-file. You can also create section-scoped sessions:

#+BEGIN_EXAMPLE
,#+PROPERTY: CLAUDE_SESSION_ID my-project-session

,* Task A
:PROPERTIES:
:CLAUDE_SESSION_ID: task-a-session
:END:

This section has its own independent session.

,#+begin_src ai
Question specific to Task A context
,#+end_src

,* Task B
:PROPERTIES:
:CLAUDE_SESSION_ID: task-b-session
:END:

This is a separate session from Task A.

,#+begin_src ai
Different context here
,#+end_src
#+END_EXAMPLE

*** Session Recovery

When Claude sessions expire, claude-org automatically:
1. Collects conversation history from the org file
2. Rebuilds context with a recovery prompt
3. Retries transparently

*Performance Optimization:*

For large org files with extensive conversation history, you can archive old sections to
improve recovery performance:

#+BEGIN_EXAMPLE
,* Old Conversations :ARCHIVE:
Sections tagged with :ARCHIVE: are automatically skipped during session recovery.

,** Ancient Discussion 1
,#+begin_src ai
Old conversation...
,#+end_src
#+END_EXAMPLE

** Permission Functions
:PROPERTIES:
:CUSTOM_ID: ref-permission-functions
:END:

Control Claude's tool use with a flexible permission functions hook. When Claude CLI is in
=acceptEdits= mode, permission functions are called for each tool request.

*** How It Works

The =claude-agent-permission-functions= variable contains a list of functions called in order.
Each function can:
- Return =nil= - Pass to next function (no decision)
- Return =(:behavior "allow")= - Allow the tool
- Return =(:behavior "deny" :message "...")= - Deny with message

The first non-nil result is used. If all return nil, the tool is allowed by default.

*** Built-in Permission Functions

| Function | Purpose |
|----------+---------|
| =claude-agent-permission-check-patterns= | Pattern-based allow/deny |
| =claude-org-permission-protect-org= | Protect .org files from direct edits |
| =claude-agent-permission-prompt= | Interactive y-or-n-p |
| =claude-agent-permission-auto-allow= | Auto-approve everything |

Recommended configuration:

#+BEGIN_SRC elisp :load no
(setq claude-agent-permission-functions
      '(claude-agent-permission-check-patterns
        claude-org-permission-protect-org
        claude-agent-permission-auto-allow))
#+END_SRC

*** Pattern-Based Permissions

Configure allow/deny patterns for automatic decisions:

#+BEGIN_SRC elisp :load no
;; Allow read-only tools and MCP Emacs tools
(setq claude-agent-allow-patterns
      '("Read" "Grep" "Glob" "mcp__emacs__*"))

;; Block dangerous commands
(setq claude-agent-deny-patterns
      '("Bash(rm -rf *)" "Bash(sudo *)" "Write(/etc/*)"))
#+END_SRC

Deny patterns are always checked first and take precedence.

*** Custom Permission Functions

Add your own permission logic:

#+BEGIN_SRC elisp :load no
(defun my-protect-config-files (tool-name tool-input context)
  "Prevent Claude from editing configuration files."
  (let ((file-path (plist-get tool-input :file_path)))
    (when (and (member tool-name '("Edit" "Write"))
               file-path
               (string-match-p "\\.\\(env\\|config\\|json\\)$" file-path))
      (list :behavior "deny"
            :message (format "Cannot modify config file: %s" file-path)))))

;; Add to permission functions (runs before pattern check)
(add-hook 'claude-agent-permission-functions
          #'my-protect-config-files)
#+END_SRC

*** Org File Protection

The =claude-org= package provides a permission function to protect .org files:

#+BEGIN_SRC elisp :load no
;; Enable org file protection (recommended)
(add-to-list 'claude-agent-permission-functions
             #'claude-org-permission-protect-org)
#+END_SRC

This blocks =Edit= and =Write= tools on .org files, directing Claude to use
=evalElisp= instead (which preserves org structure).

** Permission Modes
:PROPERTIES:
:CUSTOM_ID: ref-permission-modes
:END:

Control which tools Claude can use with pattern-based permissions.

*** Permission Presets

Access via transient menu: =C-c C-/ p=

#+BEGIN_SRC elisp :load no
;; Set globally
(setq claude-agent-permission-preset "readonly")    ; Read, Glob, Grep only
(setq claude-agent-permission-preset "accept-edits") ; + Write, Edit, MultiEdit
(setq claude-agent-permission-preset "plan")         ; Suggests changes only
(setq claude-agent-permission-preset "bypass")       ; Allow all tools
#+END_SRC

*** In claude-org-mode

Set per-file or per-section:

#+BEGIN_EXAMPLE
,#+PROPERTY: CLAUDE_PERMISSION_MODE accept-edits

,* Dangerous Section
:PROPERTIES:
:CLAUDE_PERMISSION_MODE: readonly
:END:
This section is read-only regardless of file setting.
#+END_EXAMPLE

*** Pattern Syntax

| Pattern | Example | Meaning |
|---------+---------+---------|
| =*= | =*= | Match all tools |
| =ToolName= | =WebSearch= | Match tool by name |
| =ToolName(**)= | =Read(**)= | Match with any argument |
| =ToolName(pattern)= | =Bash(git:*)= | Match argument prefix |
| =mcp__*= | =mcp__emacs__*= | Glob for MCP tools |

** IDE Context
:PROPERTIES:
:CUSTOM_ID: ref-ide-context
:END:

The library automatically collects IDE context from Emacs:
- Current file being edited
- List of open files (up to 10)
- Selected text region (if any)
- Current working directory

This context is prepended to prompts as =<system-reminder>= tags.

*** Excluding Buffers

#+BEGIN_SRC elisp :load no
;; Exclude by name pattern (regexp)
(setq claude-agent-ide-context-exclude-buffer-names
      '("*Claude Chat*" "*Messages*" "*scratch*"))

;; Exclude by major mode
(setq claude-agent-ide-context-exclude-modes
      '(claude-agent-chat-mode special-mode dired-mode))

;; Custom predicate
(add-to-list 'claude-agent-ide-context-exclude-predicates
             (lambda (buf)
               (with-current-buffer buf
                 (bound-and-true-p my-special-mode))))
#+END_SRC

** Project Configuration (claude-org)
:PROPERTIES:
:CUSTOM_ID: ref-project-configuration
:END:

*** PROJECT_ROOT

Set working directory for Claude:

#+BEGIN_EXAMPLE
,#+PROPERTY: PROJECT_ROOT /path/to/project

,* Or per-section via property drawer
,** Backend Work
   :PROPERTIES:
   :PROJECT_ROOT: /path/to/backend
   :END:
#+END_EXAMPLE

*** System Prompts

Tag sections with =:system_prompt:= to include as project guidelines:

#+BEGIN_EXAMPLE
,* Project Guidelines :system_prompt:
This project uses Python 3.11.
Always use absolute imports.
Follow PEP 8 style guide.

,* Code Style :system_prompt:
- Use type hints
- Write docstrings for all public functions
#+END_EXAMPLE

These are automatically collected and included in queries.

*** Environment Variables

You can configure Claude API settings via org properties. This is useful for:
- Using alternative API providers (e.g., [[https://www.volcengine.com/docs/82379/1928261][Volcengine/Doubao]])
- Switching models per-file or per-section
- Using custom API endpoints

Supported properties:
| Property | Description |
|----------+-------------|
| =ANTHROPIC_MODEL= | Model name to use |
| =ANTHROPIC_BASE_URL= | Custom API endpoint |
| =ANTHROPIC_AUTH_TOKEN= | API authentication token |

**** File-level Configuration

#+BEGIN_EXAMPLE
,#+PROPERTY: ANTHROPIC_MODEL claude-sonnet-4-20250514
,#+PROPERTY: ANTHROPIC_BASE_URL https://api.anthropic.com
#+END_EXAMPLE

**** Section-level Configuration

#+BEGIN_EXAMPLE
,* Work with Volcengine
:PROPERTIES:
:ANTHROPIC_BASE_URL: https://ark.cn-beijing.volces.com/api/coding
:ANTHROPIC_AUTH_TOKEN: your-ark-api-key
:ANTHROPIC_MODEL: claude-sonnet-4-20250514
:END:
#+END_EXAMPLE

**** Secure Environment Variables with ENV_FILE

*IMPORTANT SECURITY NOTICE:* Never commit API tokens or credentials to version control!

Use =ENV_FILE= to load sensitive values from a local =.env= file with variable substitution:

*Setup:*

1. Create a =.env= file (use standard dotenv syntax):

   #+BEGIN_EXAMPLE
   # ~/.local/doubao.env
   ANTHROPIC_AUTH_TOKEN=sk-ant-api03-xxx
   DOUBAO_API_KEY=your-volcengine-key
   PROJECT_PATH=/Users/yourname/projects/myapp
   #+END_EXAMPLE

2. Secure the file:

   #+BEGIN_SRC bash :load no
   chmod 600 ~/.local/doubao.env
   #+END_SRC

3. Reference in org file using =${VAR}= syntax:

   #+BEGIN_EXAMPLE
   ,#+PROPERTY: ENV_FILE ~/.local/doubao.env
   ,#+PROPERTY: ANTHROPIC_AUTH_TOKEN ${ANTHROPIC_AUTH_TOKEN}
   ,#+PROPERTY: ANTHROPIC_MODEL claude-sonnet-4-20250514
   ,#+PROPERTY: PROJECT_ROOT ${PROJECT_PATH}
   #+END_EXAMPLE

** Org Link Resolution
:PROPERTIES:
:CUSTOM_ID: ref-org-link-resolution
:END:

Claude can automatically resolve org links in your queries to fetch context. When you include
links like =[[file:notes.org::*Project Setup][Setup]]= in AI blocks, Claude uses =evalElisp=
to retrieve the linked content and inform its response.

*** Supported Link Types

| Link Format | Tool Used |
|-------------+-----------|
| =[[*Heading]]= | =evalElisp= (navigate to heading) |
| =[[file:path.org::*Heading][desc]]= | =evalElisp= (open file, read section) |
| =[[file:path.el::42][desc]]= | =Read= (with offset/limit) |
| =[[https://url][desc]]= | =WebFetch= |

*** Usage Example

Store a link with =C-c l= (=org-store-link=), then insert in your AI block with =C-c C-l=:

#+BEGIN_EXAMPLE
,* Implementation Notes

,** Important Config :reference:
The magic value is: XYZZY-12345

,* AI Chat :claude_chat:

,** Question

,#+begin_src ai
Please check the value in [[*Important Config][Important Config]] and tell me what it means.
,#+end_src
#+END_EXAMPLE

** Behavior Prompts (Tag/Header System)
:PROPERTIES:
:CUSTOM_ID: ref-behavior-prompts
:END:

Control Claude's behavior through org tags and header arguments.

*** Phase Tags

| Tag | Behavior |
|-----+----------|
| =:explore:= | Focus on understanding, use Read/Grep/Glob, do NOT modify files |
| =:plan:= | Design approach, present options with trade-offs, wait for approval |
| =:code:= | Implement solution, track progress, run tests |
| =:test:= | Write comprehensive tests, run and report results |
| =:review:= | Find bugs and issues, do NOT write new code |
| =:commit:= | Stage and commit with semantic message, do NOT push |

*** Modifier Tags

| Tag | Effect |
|-----+--------|
| =:strict:= | Zero tolerance for any issues |
| =:security:= | Apply comprehensive security analysis |
| =:no_edit:= | Read-only mode, analysis only |
| =:parallel:= | Use parallel execution for subtasks |

*** Header Arguments

| Header | Values | Effect |
|--------+--------+--------|
| =:phase= | explore/plan/code/test/review/commit | Override section phase |
| =:tests= | t | Generate comprehensive tests |
| =:coverage= | NUMBER | Require minimum test coverage % |
| =:strict= | t | Enable strict mode |
| =:files= | PATTERN | Limit scope to specific files |

** MCP Server (Emacs Tools for Claude)
:PROPERTIES:
:CUSTOM_ID: ref-mcp-server
:END:

The MCP server exposes Emacs operations to Claude Code CLI. It starts automatically
when you use claude-org-mode.

*** Manual Control

#+BEGIN_SRC elisp :load no
;; Manual start/stop
M-x emacs-mcp-server-start
M-x emacs-mcp-server-stop

;; Via transient menu
C-c C-/ m

;; Configuration
(setq emacs-mcp-server-default-port 9999)  ; optional, default is 9999
#+END_SRC

*** Available Tools

*Core Tool:*
- =evalElisp= - Execute arbitrary Emacs Lisp code

Use =evalElisp= for all Emacs operations. Use Skills (=/emacs-*=) to learn
elisp patterns for specific tasks:

| Skill | Purpose |
|-------+---------|
| =/emacs-org= | Org-mode operations (headings, properties, tables, links) |
| =/emacs-buffer= | Buffer manipulation (list, switch, create, kill) |
| =/emacs-navigation= | File and position navigation |
| =/emacs-variables= | Variable inspection and modification |
| =/emacs-introspection= | Discover functions, packages, keybindings |

*** Registering Custom Tools

#+BEGIN_SRC elisp :load no
(emacs-mcp-server-register-tool
 '((name . "my_tool")
   (description . "Does something useful")
   (handler . my-tool-handler)
   (inputSchema . ((type . "object")
                   (properties . ((arg1 . ((type . "string")))))
                   (required . ["arg1"])))))

(defun my-tool-handler (params session)
  "Handle my_tool call. PARAMS contains arguments."
  (let ((arg1 (alist-get 'arg1 params)))
    (list `((type . "text")
            (text . ,(format "Result: %s" arg1))))))
#+END_SRC

** Output Formatting (claude-org)
:PROPERTIES:
:CUSTOM_ID: ref-output-formatting
:END:

*** Header Normalization

When Claude outputs org headers, they're automatically adjusted to fit your document hierarchy.

#+BEGIN_SRC elisp :load no
;; Enable/disable header normalization (default: t)
(setq claude-org-normalize-headers t)
#+END_SRC

*** Auto Line Breaking

Long lines can be automatically broken after sentence-ending punctuation.

#+BEGIN_SRC elisp :load no
;; Break lines after 110 characters (at sentence boundaries)
(setq claude-org-auto-break-line-length 110)

;; Disable auto-breaking (default)
(setq claude-org-auto-break-line-length -1)
#+END_SRC

*** Auto Title Generation

When executing AI blocks under generic "Instruction N" headings, titles are automatically
generated using the Haiku model.

#+BEGIN_SRC elisp :load no
;; Enable auto-title generation (default: t)
(setq claude-org-auto-generate-title t)

;; Only replace headings matching this pattern
(setq claude-org-auto-title-heading-pattern "^Instruction [0-9]+$")
#+END_SRC

** Error Analysis
:PROPERTIES:
:CUSTOM_ID: ref-error-analysis
:END:

AI-powered analysis of Emacs errors using Claude.

*** Usage

When an error occurs and the =*Backtrace*= buffer appears:

#+BEGIN_SRC elisp :load no
;; Analyze the current backtrace
M-x claude-agent-analyze-backtrace

;; Or analyze selected error text
M-x claude-agent-analyze-region
#+END_SRC

*** Automatic Analysis (Recommended)

#+BEGIN_SRC elisp :load no
;; Auto-analyze on debugger entry
(add-hook 'debugger-mode-hook #'claude-agent-analyze-backtrace)
#+END_SRC

** Activity Mode-Line
:PROPERTIES:
:CUSTOM_ID: ref-activity-mode-line
:END:

Shows when Claude queries are active.

- Spinning indicator =[C:◐]= during queries
- Count for multiple: =[C:◓×3]=
- Click to open session manager

#+BEGIN_SRC elisp :load no
;; View active queries
M-x claude-agent-list-queries
#+END_SRC

** Usage Mode-Line
:PROPERTIES:
:CUSTOM_ID: ref-usage-mode-line
:END:

Display Claude API usage statistics.

*** Setup

#+BEGIN_SRC elisp :load no
;; Set your organization ID (from claude.ai URL)
(setq claude-agent-usage-org-id "your-org-id-here")

;; Set environment variable for session key
;; Get from browser: DevTools > Application > Cookies > sessionKey
;; export CLAUDE_SESSION_KEY="your-session-key"
#+END_SRC

*** Usage

#+BEGIN_SRC elisp :load no
M-x claude-agent-usage-mode-line-start  ; Start (auto-refresh every 5 min)
M-x claude-agent-usage-mode-line-stop   ; Stop
M-x claude-agent-usage-fetch            ; Manual refresh
#+END_SRC

** Verbose Output Buffers
:PROPERTIES:
:CUSTOM_ID: ref-verbose-output
:END:

Per-session verbose buffers display CLI-like output.

#+BEGIN_SRC elisp :load no
;; In claude-org-mode
C-c C-v  ; Show verbose buffer for current session

;; Or via transient menu
C-c C-/ v

;; Programmatically
M-x claude-agent-show-session-verbose
M-x claude-agent-list-session-verbose-buffers
#+END_SRC

** Skills (User Settings)
:PROPERTIES:
:CUSTOM_ID: ref-skills
:END:

Claude Code supports loading custom skills from =~/.claude/skills/=.

*** Setting Sources

#+BEGIN_SRC elisp :load no
;; Default: load user skills from ~/.claude/skills/
(setq claude-org-setting-sources '("user"))

;; Load from multiple sources
(setq claude-org-setting-sources '("user" "project" "local"))
#+END_SRC

*** Skill File Format

Skills are markdown files in subdirectories of =~/.claude/skills/=:

#+BEGIN_EXAMPLE
~/.claude/skills/
├── emacs-org/
│   └── skill.md
├── python-dev/
│   └── skill.md
└── code-review/
    └── skill.md
#+END_EXAMPLE

** Configuration Reference
:PROPERTIES:
:CUSTOM_ID: configuration-reference
:END:

*** claude-agent
:PROPERTIES:
:CUSTOM_ID: config-claude-agent
:END:

#+BEGIN_SRC elisp :load no
;; CLI path (auto-detected if nil)
(setq claude-agent-cli-path "/path/to/claude")

;; Debug logging
(setq claude-agent-debug t)

;; Permission functions (recommended configuration)
(setq claude-agent-permission-functions
      '(claude-agent-permission-check-patterns
        claude-org-permission-protect-org
        claude-agent-permission-auto-allow))

;; Auto-analyze errors (recommended)
(add-hook 'debugger-mode-hook #'claude-agent-analyze-backtrace)

;; Verbose buffer cleanup
(setq claude-agent-verbose-buffer-auto-kill t)

;; Error Analysis
(setq claude-agent-error-debounce-delay 0.5)
(setq claude-agent-error-prompt-file "~/my-prompt.org")
(setq claude-agent-error-mcp-config "~/.config/claude/mcp.json")
#+END_SRC

*** claude-org
:PROPERTIES:
:CUSTOM_ID: config-claude-org
:END:

#+BEGIN_SRC elisp :load no
;; Font-lock delay during streaming (lower = more responsive)
(setq claude-org-fontlock-delay 0.05)

;; Default tags
(setq claude-org-heading-tag "claude_chat")

;; Include IDE context in prompts
(setq claude-org-include-ide-context t)

;; Show system messages in response
(setq claude-org-show-system-messages nil)

;; Maximum line width hint for Claude
(setq claude-org-line-width 170)

;; Auto-break long lines after sentence punctuation (-1 to disable)
(setq claude-org-auto-break-line-length 110)

;; Normalize org headers in output
(setq claude-org-normalize-headers t)

;; Auto-generate titles for "Instruction N" headings
(setq claude-org-auto-generate-title t)
(setq claude-org-auto-title-heading-pattern "^Instruction [0-9]+$")

;; MCP server auto-start (default: t)
(setq claude-org-auto-start-mcp-server t)

;; Default system prompts
(setq claude-org-default-system-prompts '("Your custom prompt"))

;; Setting sources for loading skills
(setq claude-org-setting-sources '("user"))
#+END_SRC

*** emacs-mcp-server
:PROPERTIES:
:CUSTOM_ID: config-emacs-mcp-server
:END:

#+BEGIN_SRC elisp :load no
;; Default port (0 = auto-select)
(setq emacs-mcp-server-default-port 9999)

;; Permission mode for tools
(setq emacs-mcp-server-permission-mode "acceptEdits")

;; Allowed tool patterns
(setq emacs-mcp-server-allowed-tools '("mcp__emacs__*"))

;; Max output length from evalElisp
(setq emacs-mcp-server-max-output-length 50000)
#+END_SRC

*** claude-agent-chat
:PROPERTIES:
:CUSTOM_ID: config-claude-agent-chat
:END:

#+BEGIN_SRC elisp :load no
;; Prompt string
(setq claude-agent-chat-prompt "You> ")

;; Buffer name
(setq claude-agent-chat-buffer-name "*Claude Chat*")

;; Show system messages
(setq claude-agent-chat-show-system-messages nil)

;; Show cost after each response
(setq claude-agent-chat-show-cost t)

;; Include IDE context
(setq claude-agent-chat-include-ide-context t)
#+END_SRC

** API Reference
:PROPERTIES:
:CUSTOM_ID: api-reference
:END:

*** Core Functions (claude-agent)
:PROPERTIES:
:CUSTOM_ID: api-core-functions
:END:

| Function | Description |
|----------+-------------|
| =claude-agent-query= | Send one-shot query with callbacks |
| =claude-agent-options= | Create options plist |
| =claude-agent-extract-text= | Extract text from assistant message |
| =claude-agent-extract-tool-uses= | Extract tool use blocks |
| =claude-agent-extract-thinking= | Extract thinking content |
| =claude-agent-message-type= | Get message type symbol |
| =claude-agent-cancel-query= | Cancel specific query |
| =claude-agent-cancel-all-queries= | Cancel all active queries |
| =claude-agent-active-query-count= | Get number of active queries |

*** Client Functions
:PROPERTIES:
:CUSTOM_ID: api-client-functions
:END:

| Function | Description |
|----------+-------------|
| =claude-agent-client-create= | Create new client |
| =claude-agent-client-connect= | Connect to Claude |
| =claude-agent-client-send= | Send message |
| =claude-agent-client-disconnect= | Disconnect |
| =claude-agent-client-interrupt= | Interrupt current operation |

*** Org Functions (claude-org)
:PROPERTIES:
:CUSTOM_ID: api-org-functions
:END:

| Function | Description |
|----------+-------------|
| =claude-org-mode= | Enable/disable minor mode |
| =claude-org-execute= | Execute AI block (C-c C-c) |
| =claude-org-cancel= | Cancel current query |
| =claude-org-insert-block= | Insert new AI block with tag selection |
| =claude-org-insert-sdd= | Insert SDD structure |
| =claude-org-show-session-info= | Show session identity |
| =claude-org-list-sessions= | List all sessions |
| =claude-org-show-verbose= | Show verbose output |
| =claude-org-switch-permission-mode= | Change permission mode |
| =claude-org-menu= | Open transient menu (C-c C-/) |

*** MCP Server Functions
:PROPERTIES:
:CUSTOM_ID: api-mcp-server-functions
:END:

| Function | Description |
|----------+-------------|
| =emacs-mcp-server-start= | Start MCP server |
| =emacs-mcp-server-stop= | Stop MCP server |
| =emacs-mcp-server-running-p= | Check if running |
| =emacs-mcp-server-port= | Get current port |
| =emacs-mcp-server-register-tool= | Register custom tool |
| =emacs-mcp-server-unregister-tool= | Unregister tool |
| =claude-mcp-org-enable= | Enable org tools |
| =claude-mcp-org-disable= | Disable org tools |

** FAQ
:PROPERTIES:
:CUSTOM_ID: faq
:END:

*** Installation Issues
:PROPERTIES:
:CUSTOM_ID: faq-installation
:END:

**** "Claude CLI not found"

*Symptoms:* Error message about missing =claude= command.

*Solutions:*

1. Verify Claude Code CLI is installed:
   #+BEGIN_SRC bash :load no
   which claude
   # or
   claude --version
   #+END_SRC

2. If not in PATH, set the path explicitly:
   #+BEGIN_SRC elisp :load no
   (setq claude-agent-cli-path "/usr/local/bin/claude")
   #+END_SRC

3. Install if missing:
   #+BEGIN_SRC bash :load no
   npm install -g @anthropic-ai/claude-code
   #+END_SRC

**** "literate-elisp not found"

*Symptoms:* Error when loading claude-agent.org.

*Solutions:*

1. Install literate-elisp:
   #+BEGIN_SRC elisp :load no
   (use-package literate-elisp
     :straight (:type git :host github :repo "jingtaozf/literate-elisp"))
   #+END_SRC

2. Verify installation:
   #+BEGIN_SRC elisp :load no
   (require 'literate-elisp)
   #+END_SRC

*** Session Issues
:PROPERTIES:
:CUSTOM_ID: faq-sessions
:END:

**** "Session expired" or context lost

*Symptoms:* Claude doesn't remember previous conversation.

*Explanation:* Claude Code sessions expire after inactivity. claude-org automatically
attempts recovery, but this may fail if:
- The org file has been heavily modified
- The conversation history is very long

*Solutions:*

1. Check session info via transient menu:
   #+BEGIN_EXAMPLE
   C-c C-/ s
   #+END_EXAMPLE

2. Start a fresh session:
   - Create a new section with its own =CLAUDE_SESSION_ID= property

3. Archive old conversations to reduce recovery size:
   #+BEGIN_EXAMPLE
   ,* Old Stuff :ARCHIVE:
   ...old conversations...
   #+END_EXAMPLE

**** Independent sections sharing context

*Symptoms:* Sections seem to share context unexpectedly.

*Solution:* Ensure each independent section has its own =CLAUDE_SESSION_ID= property:

#+BEGIN_EXAMPLE
,* Task A
:PROPERTIES:
:CLAUDE_SESSION_ID: unique-id-for-task-a
:END:
#+END_EXAMPLE

*** Permission Issues
:PROPERTIES:
:CUSTOM_ID: faq-permissions
:END:

**** "Tool blocked" unexpectedly

*Symptoms:* Claude reports a tool was denied but you expected it to work.

*Solutions:*

1. Check current permission mode via transient menu:
   #+BEGIN_EXAMPLE
   C-c C-/ p
   #+END_EXAMPLE

2. Review deny patterns:
   #+BEGIN_SRC elisp :load no
   claude-agent-deny-patterns
   #+END_SRC

3. Enable debug logging to see permission decisions:
   #+BEGIN_SRC elisp :load no
   (setq claude-agent-debug t)
   #+END_SRC

**** How to allow a specific tool

#+BEGIN_SRC elisp :load no
;; Add to allow patterns
(add-to-list 'claude-agent-allow-patterns "ToolName")

;; Or for tools with arguments
(add-to-list 'claude-agent-allow-patterns "Bash(git:*)")
#+END_SRC

*** MCP Server Issues
:PROPERTIES:
:CUSTOM_ID: faq-mcp
:END:

**** "MCP server won't start"

*Symptoms:* =emacs-mcp-server-start= fails or returns error.

*Solutions:*

1. Check if =web-server= package is installed:
   #+BEGIN_SRC elisp :load no
   (require 'web-server)
   #+END_SRC

2. Check if port is already in use:
   #+BEGIN_SRC elisp :load no
   ;; Use auto-select port
   (setq emacs-mcp-server-default-port 0)
   #+END_SRC

3. Check server status:
   #+BEGIN_SRC elisp :load no
   (emacs-mcp-server-running-p)
   (emacs-mcp-server-port)
   #+END_SRC

**** "evalElisp not available"

*Symptoms:* Claude can't use the evalElisp tool.

*Solutions:*

1. Verify MCP server is running:
   #+BEGIN_SRC elisp :load no
   (emacs-mcp-server-running-p)  ; Should return t
   #+END_SRC

2. Check MCP config in Claude Code settings:
   - The MCP server URL should be =http://localhost:PORT=

*** Org-mode Issues
:PROPERTIES:
:CUSTOM_ID: faq-org-mode
:END:

**** "Block not executing" (C-c C-c does nothing)

*Symptoms:* Pressing =C-c C-c= in an AI block has no effect.

*Solutions:*

1. Verify claude-org-mode is enabled:
   #+BEGIN_EXAMPLE
   M-x claude-org-mode
   #+END_EXAMPLE

2. Check cursor is inside the =#+begin_src ai= block

3. Verify the block syntax is correct:
   #+BEGIN_EXAMPLE
   ,#+begin_src ai
   Your query here
   ,#+end_src
   #+END_EXAMPLE

**** "Streaming not working" (response appears all at once)

*Symptoms:* Response doesn't stream character-by-character.

*Solution:* This is expected behavior in some terminal environments. The streaming
happens at the CLI level; what you see is buffered output.

* Appendix
:PROPERTIES:
:CUSTOM_ID: appendix
:END:

** Related Projects
:PROPERTIES:
:CUSTOM_ID: related-projects
:END:

*** Reference Implementation

This project references Anthropic's official SDK:

| Project | Description | Location |
|---------+-------------+----------|
| [[https://github.com/anthropics/claude-agent-sdk-python][claude-agent-sdk-python]] | Official Python SDK | =reference/claude-agent-sdk-python/= |

The Python SDK provides the canonical implementation of the Claude Agent protocol.
Key features implemented here follow the same design patterns.

*** Dependencies

| Project | Description | Purpose |
|---------+-------------+---------|
| [[https://github.com/jingtaozf/literate-elisp][literate-elisp]] | Load org files as elisp | Literate programming foundation |
| [[https://github.com/eschulte/emacs-web-server][emacs-web-server]] | HTTP server for Emacs | MCP server backend |
| [[https://github.com/magit/transient][transient]] | Transient commands | Command menu (=C-c C-/=) |

*** Alternative Approaches

| Project | Description | Best For |
|---------+-------------+----------|
| [[https://xenodium.com/introducing-agent-shell][agent-shell]] | Shell-mode interface for AI agents | Terminal-style interactions |
| [[https://agentclientprotocol.com/][Agent Client Protocol]] | Standard protocol for AI agents | Protocol-agnostic integrations |

** Running Tests
:PROPERTIES:
:CUSTOM_ID: running-tests
:END:

*** Quick Start

#+BEGIN_SRC bash :load no
# Run all tests
make test

# Run unit tests only (fast, no API calls)
make test-unit

# Run integration tests (requires Claude API)
make test-integration
#+END_SRC

*** Running Tests in Emacs

#+BEGIN_SRC elisp :load no
(setq literate-elisp-test-p t)
(literate-elisp-load "~/projects/claude-agent/claude-agent.org")
(literate-elisp-load "~/projects/claude-agent/claude-org.org")
(ert t)  ; Run all tests

;; Run only unit tests (no API)
(ert '(tag :unit))
#+END_SRC

** License
:PROPERTIES:
:CUSTOM_ID: license
:END:

MIT
