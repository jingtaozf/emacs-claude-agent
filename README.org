#+TITLE: Claude Agent SDK for Emacs
#+AUTHOR: Jingtao Xu

* Overview

This is an Emacs client library for the [[https://claude.ai/code][Claude Code CLI]], implemented using literate programming in Org mode.

The library mirrors the Python Claude Agent SDK API, providing:
- ~claude-agent-query~ for one-shot queries
- ~claude-agent-client~ for bidirectional interactive conversations
- ~claude-agent-chat~ for comint-based REPL interaction
- Streaming response support via callbacks
- Permission system with pattern matching
- IDE context collection (current file, open files, selection)
- File-based session management
- Query cancellation support
- Activity mode-line indicator (shows when queries are active)
- Per-session verbose output buffers (CLI-like output view)
- Usage mode-line display

* Prerequisites

- Emacs 27.1+
- Claude Code CLI installed (~npm install -g @anthropic-ai/claude-code~ or via [[https://claude.ai/install.sh][install script]])
- [[https://github.com/jingtaoxu/literate-elisp][literate-elisp]] for loading the org file directly

* Installation

** Direct Loading (Development)

#+BEGIN_SRC elisp
(require 'literate-elisp)
(literate-elisp-load "~/projects/claude-agent/claude-agent.org")
#+END_SRC

** Tangled File

Generate ~claude-agent.el~ from the org file:

#+BEGIN_SRC elisp
(require 'literate-elisp)
(literate-elisp-tangle "~/projects/claude-agent/claude-agent.org")
#+END_SRC

Then add to load-path:

#+BEGIN_SRC elisp
(add-to-list 'load-path "~/projects/claude-agent/")
(require 'claude-agent)
#+END_SRC

* Usage

** Interactive Chat Mode

The easiest way to interact with Claude:

#+BEGIN_SRC elisp
M-x claude-agent-chat
#+END_SRC

This opens a comint-based buffer where you can:
- Type messages and press RET to send
- ~C-c C-k~ to interrupt current request
- ~C-c C-l~ to clear and reset session
- ~C-c C-n~ to start new session without clearing

The chat automatically includes IDE context (current file, open files, selection).

** One-shot Query

#+BEGIN_SRC elisp
(claude-agent-query
 "What is 2+2?"
 :on-message (lambda (msg)
               (when (claude-agent-assistant-message-p msg)
                 (message "Response: %s"
                          (claude-agent-extract-text msg))))
 :on-complete (lambda (_) (message "Done!")))
#+END_SRC

** With Options

#+BEGIN_SRC elisp
(claude-agent-query
 "Explain this code"
 :options (claude-agent-options
           :model "claude-sonnet-4-5"
           :max-turns 3
           :permission-mode 'accept-edits)
 :on-message #'my-message-handler)
#+END_SRC

** Interactive Client

#+BEGIN_SRC elisp
(let ((client (claude-agent-client-create
               :options (claude-agent-options :model "claude-sonnet-4-5")
               :on-message (lambda (msg)
                             (message "Got: %s" (claude-agent-message-type msg))))))
  (claude-agent-client-connect client "Hello, Claude!")
  ;; Later...
  (claude-agent-client-send client "Follow-up question"))
#+END_SRC

* Permission System

Control which tools Claude can use with pattern-based permissions.

** Permission Presets

#+BEGIN_SRC elisp
;; Use a preset (default: "readonly")
(setq claude-agent-permission-preset "readonly")    ; Read, Glob, Grep, WebSearch, WebFetch
(setq claude-agent-permission-preset "accept-edits") ; Adds Write, Edit, MultiEdit
(setq claude-agent-permission-preset "bypass")       ; Allow all
(setq claude-agent-permission-preset "custom")       ; Use claude-agent-permissions
#+END_SRC

** Custom Permissions

#+BEGIN_SRC elisp
(setq claude-agent-permission-preset "custom")
(setq claude-agent-permissions
      '(:allow ("Read(**)" "Glob(**)" "Bash(git:*)")
        :deny ("Bash(rm *)" "Bash(sudo *)")))
#+END_SRC

** Pattern Syntax

| Pattern | Example | Meaning |
|---------+---------+---------|
| ~*~ | ~*~ | Match all tools |
| ~ToolName~ | ~WebSearch~ | Match tool by name |
| ~ToolName(**)~ | ~Read(**)~ | Match with any argument |
| ~ToolName(pattern)~ | ~Bash(git:*)~ | Match with argument pattern |
| ~mcp__*~ | ~mcp__emacs__*~ | Glob for MCP tools |

* IDE Context

The library automatically collects IDE context from Emacs:
- Current file being edited
- List of open files (up to 10)
- Selected text region (if any)
- Current working directory

This context is prepended to prompts as ~<system-reminder>~ tags.

** Customizing Buffer Exclusions

#+BEGIN_SRC elisp
;; Exclude buffers by name pattern (regexp)
(setq claude-agent-ide-context-exclude-buffer-names
      '("*Claude Chat*" "*Messages*" "*scratch*"))

;; Exclude buffers by major mode
(setq claude-agent-ide-context-exclude-modes
      '(claude-agent-chat-mode special-mode dired-mode))

;; Add custom predicate for exclusion
(add-to-list 'claude-agent-ide-context-exclude-predicates
             (lambda (buf)
               (with-current-buffer buf
                 (bound-and-true-p my-special-mode))))
#+END_SRC

** Manual Context Collection

#+BEGIN_SRC elisp
;; Get IDE context as plist
(claude-agent-collect-ide-context)
;; => (:current-file (:name "foo.el" :path "/path/to/foo.el" :modified t)
;;     :open-files (...)
;;     :selection (:text "..." :start-line 10 :end-line 15)
;;     :cwd "/path/to/project/")

;; Build system reminder string
(claude-agent-get-system-reminder "/path/to/notebook.org")
#+END_SRC

* Session Management

Sessions allow continuing conversations across queries.

#+BEGIN_SRC elisp
;; Sessions are automatically managed in claude-agent-chat

;; For programmatic use:
(claude-agent--make-session-key "/path/to/file.org" "my-session")
;; => "/path/to/file.org::my-session"

;; Store/retrieve SDK UUIDs
(claude-agent--store-sdk-uuid session-key uuid)
(claude-agent--get-sdk-uuid session-key)
(claude-agent--clear-session session-key)
#+END_SRC

* Query Cancellation

#+BEGIN_SRC elisp
;; Cancel a specific query
(claude-agent-cancel-query request-id)

;; Cancel all active queries
(claude-agent-cancel-all-queries)

;; In chat mode, use C-c C-k to interrupt
#+END_SRC

* Activity Mode-Line

The activity mode-line indicator shows when Claude queries are active.

** Features

- Automatically enabled when ~claude-agent.org~ is loaded
- Shows spinning indicator ~[C:◐]~ when queries are active
- Shows count for multiple queries: ~[C:◓×3]~
- Click to open session manager
- Hover for detailed query information with elapsed time

** Session Manager

Click the mode-line indicator or run:

#+BEGIN_SRC elisp
M-x claude-agent-list-queries
#+END_SRC

In the session manager:
- ~k~ - Cancel query at point
- ~K~ - Cancel all queries
- ~g~ - Refresh list
- ~q~ - Quit

* Verbose Output Buffers

Per-session verbose buffers display CLI-like output for all queries within a session.

** Usage

When using ~claude-agent-query~ with ~:session-key~, messages are written to a verbose buffer:

#+BEGIN_SRC elisp
(claude-agent-query
 "Analyze this code"
 :session-key "my-project::main"
 :on-message #'my-handler)
#+END_SRC

** View Commands

#+BEGIN_SRC elisp
;; Show verbose buffer for a specific session
M-x claude-agent-show-session-verbose

;; List all session verbose buffers
M-x claude-agent-list-session-verbose-buffers
#+END_SRC

** Buffer Contents

The verbose buffer shows:
- Session header with start time
- Query headers with timestamps
- Tool calls (Read, Write, Bash, etc.)
- Thinking indicators
- Text responses
- Completion summary (duration, cost)

** Cleanup

#+BEGIN_SRC elisp
;; Auto-kill verbose buffers when sessions are cleared
(setq claude-agent-verbose-buffer-auto-kill t)
#+END_SRC

* Usage Mode-Line

Display Claude API usage statistics in the mode-line.

** Setup

#+BEGIN_SRC elisp
;; Set your organization ID (from claude.ai URL)
(setq claude-agent-usage-org-id "your-org-id-here")

;; Set environment variable for session key
;; Get from browser: DevTools > Application > Cookies > sessionKey
;; export CLAUDE_SESSION_KEY="your-session-key"
#+END_SRC

** Usage

#+BEGIN_SRC elisp
;; Start mode-line display (auto-refresh every 5 min during work hours)
M-x claude-agent-usage-mode-line-start

;; Stop mode-line display
M-x claude-agent-usage-mode-line-stop

;; Manual refresh
M-x claude-agent-usage-fetch
#+END_SRC

** Display Format

- ~[C:XX|YY|ZZ]~ - 5-hour | 7-day | 7-day Sonnet utilization percentages
- ~[C:ERR]~ - API error (hover for details, click to retry)
- ~[C:CFG]~ - Missing configuration

Hover over the display for a tooltip with reset times.

* Customization

#+BEGIN_SRC elisp
;; Set default model
(setq claude-agent-default-model "claude-sonnet-4-5")

;; Explicit CLI path
(setq claude-agent-cli-path "/path/to/claude")

;; Enable debug logging
(setq claude-agent-debug t)

;; Chat mode settings
(setq claude-agent-chat-prompt "You> ")
(setq claude-agent-chat-show-cost t)
(setq claude-agent-chat-show-system-messages nil)
(setq claude-agent-chat-include-ide-context t)
#+END_SRC

* API Reference

** Core Functions

- ~claude-agent-query~ - Send one-shot query
- ~claude-agent-options~ - Create options plist
- ~claude-agent-extract-text~ - Extract text from assistant message
- ~claude-agent-extract-tool-uses~ - Extract tool use blocks
- ~claude-agent-extract-thinking~ - Extract thinking content
- ~claude-agent-message-type~ - Get message type symbol

** Client Functions

- ~claude-agent-client-create~ - Create new client
- ~claude-agent-client-connect~ - Connect to Claude
- ~claude-agent-client-send~ - Send message
- ~claude-agent-client-disconnect~ - Disconnect
- ~claude-agent-client-interrupt~ - Interrupt current operation

** Chat Functions

- ~claude-agent-chat~ - Open interactive chat buffer
- ~claude-agent-chat-interrupt~ - Interrupt current request (C-c C-k)
- ~claude-agent-chat-clear~ - Clear and reset session (C-c C-l)
- ~claude-agent-chat-new-session~ - Start new session (C-c C-n)

** Permission Functions

- ~claude-agent-permission-match-p~ - Check if tool matches pattern
- ~claude-agent-check-permission~ - Check allow/deny for tool
- ~claude-agent-get-effective-permissions~ - Get current permissions
- ~claude-agent-make-permission-hook~ - Create PreToolUse hook

** IDE Context Functions

- ~claude-agent-collect-ide-context~ - Collect current IDE state
- ~claude-agent-get-system-reminder~ - Build system-reminder string
- ~claude-agent-build-system-reminder~ - Build with explicit args

** Session Functions

- ~claude-agent--make-session-key~ - Create session key
- ~claude-agent--get-sdk-uuid~ - Get SDK UUID for session
- ~claude-agent--store-sdk-uuid~ - Store session mapping
- ~claude-agent--clear-session~ - Clear session mapping

** Activity Functions

- ~claude-agent-active-query-count~ - Get number of active queries
- ~claude-agent-active-p~ - Check if any queries are active
- ~claude-agent-list-queries~ - Open session manager buffer
- ~claude-agent-cancel-all-queries~ - Cancel all active queries

** Verbose Output Functions

- ~claude-agent-show-session-verbose~ - Show verbose buffer for a session
- ~claude-agent-list-session-verbose-buffers~ - List all verbose buffers

** Usage Functions

- ~claude-agent-usage-mode-line-start~ - Start mode-line display
- ~claude-agent-usage-mode-line-stop~ - Stop mode-line display
- ~claude-agent-usage-fetch~ - Fetch usage data

* Running Tests

Load the org file with ~literate-elisp-test-p~ set to ~t~, then run ~M-x ert~:

#+BEGIN_SRC elisp
(setq literate-elisp-test-p t)
(literate-elisp-load "~/projects/claude-agent/claude-agent.org")
(ert t)  ; Run all tests
#+END_SRC

* License

MIT
